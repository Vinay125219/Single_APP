name: Build Linux (RHEL7-compatible) - normal and kiosk

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build normal and kiosk executables inside CentOS7 container
        uses: addnab/docker-run-action@v3
        with:
          image: centos:7
          options: -v ${{ github.workspace }}:/src
          run: |
            set -e
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo
            sed -i 's|#baseurl=http://mirror.centos.org/centos|baseurl=http://vault.centos.org/centos|g' /etc/yum.repos.d/CentOS-*.repo

            yum -y update
            yum -y install epel-release
            yum -y install python3 python3-pip python3-devel gcc gcc-c++ make which \
                           tk tcl python3-tkinter

            python3 --version

            pip3 install --upgrade pip setuptools wheel
            pip3 install pyinstaller flake8

            cd /src

            echo "Linting with flake8..."
            flake8 . --count --exit-zero --max-line-length=127 --statistics
            echo "âœ… Linting complete."

            python3 -c "import main; print('Script syntax OK')"

            export TCL_LIBRARY=/usr/share/tcl8.5
            export TK_LIBRARY=/usr/share/tk8.5

            # Normal build
            pyinstaller --onefile --noconsole main.py -n device_monitor_linux \
              --add-binary "/usr/lib64/libtcl8.5.so:." \
              --add-binary "/usr/lib64/libtk8.5.so:." \
              --add-data "/usr/share/tcl8.5:lib/tcl8.5" \
              --add-data "/usr/share/tk8.5:lib/tk8.5"

            # Kiosk build (duplicate binary with _kiosk suffix)
            mkdir -p build_kiosk
            cp dist/device_monitor_linux build_kiosk/device_monitor_linux_kiosk
            chmod +x build_kiosk/device_monitor_linux_kiosk

      - name: Upload Linux Executables
        uses: actions/upload-artifact@v4
        with:
          name: linux-executables
          path: |
            dist/device_monitor_linux
            build_kiosk/device_monitor_linux_kiosk 