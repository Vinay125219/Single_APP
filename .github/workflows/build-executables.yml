name: Build Device Monitor Executables

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: false
        default: "dev"

env:
  PYTHON_VERSION: "3.9"
  APP_NAME: "device_monitor"

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-tk \
            python3-dev \
            build-essential \
            libffi-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            libssl-dev \
            zlib1g-dev \
            libncurses5-dev \
            libgdbm-dev \
            libnss3-dev \
            wget

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Create version info
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Build executable with PyInstaller
        run: |
          # Create PyInstaller spec file
          cat > device_monitor.spec << EOF
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          a = Analysis(
              ['main.py'],
              pathex=['.'],
              binaries=[],
              datas=[],
              hiddenimports=[
                  'tkinter',
                  'tkinter.ttk',
                  'tkinter.messagebox',
                  'tkinter.filedialog',
                  'threading',
                  'subprocess',
                  'queue',
                  'logging',
                  'pathlib',
                  'json',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='device_monitor_linux',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )
          EOF

          # Build the executable
          pyinstaller device_monitor.spec --clean --noconfirm

          # Verify executable was created
          if [ -f "dist/device_monitor_linux" ]; then
            echo "‚úÖ Successfully built device_monitor_linux"
            chmod +x "dist/device_monitor_linux"
            ls -lh "dist/device_monitor_linux"
          else
            echo "‚ùå Failed to build executable"
            exit 1
          fi

      - name: Create release package
        run: |
          mkdir -p release/linux
          cp dist/device_monitor_linux release/linux/

          # Create README
          cat > release/linux/README.txt << EOF
          Device Monitor - Linux Build
          Version: ${{ env.VERSION }}
          Built: $(date)
          Platform: Linux x64

          Usage:
            ./device_monitor_linux

          For more information, see the documentation at:
          https://github.com/${{ github.repository }}
          EOF

          # Create archive
          cd release
          tar -czf device_monitor_linux_${{ env.VERSION }}.tar.gz linux/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: device-monitor-linux-${{ env.VERSION }}
          path: release/device_monitor_linux_${{ env.VERSION }}.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install pywin32
          pip install -r requirements.txt

      - name: Create version info
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Create version resource file
        run: |
          $versionInfo = @"
          # UTF-8
          #
          # For more details about fixed file info 'ffi' see:
          # http://msdn.microsoft.com/en-us/library/ms646997.aspx
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=(1,0,0,0),
              prodvers=(1,0,0,0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'040904B0',
                  [StringStruct(u'CompanyName', u'Device Monitor'),
                  StringStruct(u'FileDescription', u'Device Monitor Application'),
                  StringStruct(u'FileVersion', u'${{ env.VERSION }}'),
                  StringStruct(u'InternalName', u'device_monitor'),
                  StringStruct(u'LegalCopyright', u'Copyright (c) 2024'),
                  StringStruct(u'OriginalFilename', u'device_monitor_windows.exe'),
                  StringStruct(u'ProductName', u'Device Monitor'),
                  StringStruct(u'ProductVersion', u'${{ env.VERSION }}')])]
                ), 
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          "@

          $versionInfo | Out-File -FilePath "version_info.py" -Encoding UTF8

      - name: Build executable with PyInstaller
        run: |
          $specContent = @"
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          a = Analysis(
              ['main.py'],
              pathex=['.'],
              binaries=[],
              datas=[],
              hiddenimports=[
                  'tkinter',
                  'tkinter.ttk',
                  'tkinter.messagebox',
                  'tkinter.filedialog',
                  'threading',
                  'subprocess',
                  'queue',
                  'logging',
                  'pathlib',
                  'json',
                  'win32serviceutil',
                  'win32service',
                  'win32event',
                  'servicemanager',
                  'win32ts',
                  'win32con',
                  'win32api',
                  'win32gui',
                  'win32process',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='device_monitor_windows',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              version='version_info.py',
              icon=None,
          )
          "@

          $specContent | Out-File -FilePath "device_monitor.spec" -Encoding UTF8

          # Build the executable
          pyinstaller "device_monitor.spec" --clean --noconfirm

          # Verify executable was created
          if (Test-Path "dist\device_monitor_windows.exe") {
            Write-Output "‚úÖ Successfully built device_monitor_windows.exe"
            Get-ChildItem "dist\device_monitor_windows.exe" | Format-List
          } else {
            Write-Output "‚ùå Failed to build executable"
            exit 1
          }

      - name: Create release package
        run: |
          New-Item -ItemType Directory -Path "release\windows" -Force
          Copy-Item "dist\device_monitor_windows.exe" -Destination "release\windows\"

          # Create README
          $readmeContent = @"
          Device Monitor - Windows Build
          Version: ${{ env.VERSION }}
          Built: $(Get-Date)
          Platform: Windows x64

          Usage:
            device_monitor_windows.exe

          For more information, see the documentation at:
          https://github.com/${{ github.repository }}
          "@

          $readmeContent | Out-File -FilePath "release\windows\README.txt" -Encoding UTF8

          # Create archive
          cd release
          Compress-Archive -Path "windows" -DestinationPath "device_monitor_windows_${{ env.VERSION }}.zip"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: device-monitor-windows-${{ env.VERSION }}
          path: release/device_monitor_windows_${{ env.VERSION }}.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create version info
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.zip" -exec cp {} release-assets/ \;
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: ${{ github.ref_name }}
          name: Device Monitor v${{ env.VERSION }}
          body: |
            # Device Monitor v${{ env.VERSION }}

            ## üì¶ Available Downloads

            ### Linux (RHEL 7.9+, Ubuntu)
            - **device_monitor_linux_${{ env.VERSION }}.tar.gz** - Linux executable

            ### Windows (10/11)
            - **device_monitor_windows_${{ env.VERSION }}.zip** - Windows executable

            ## üöÄ Quick Start

            ### Linux Installation
            ```bash
            # Extract the archive
            tar -xzf device_monitor_linux_${{ env.VERSION }}.tar.gz
            cd linux/

            # Run the executable
            ./device_monitor_linux
            ```

            ### Windows Installation
            ```cmd
            REM Extract the ZIP file
            REM Run the executable:
            device_monitor_windows.exe
            ```

            ## üìã System Requirements

            **Linux (RHEL 7.9+)**
            - X11 display server
            - No additional dependencies required

            **Windows (10/11)**
            - No additional dependencies required

            ## üîß Features

            - ‚úÖ USB device monitoring
            - ‚úÖ System control (shutdown/restart)
            - ‚úÖ Application launcher
            - ‚úÖ Comprehensive logging
            - ‚úÖ Cross-platform support

            Built with ‚ù§Ô∏è using GitHub Actions
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Development Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: dev-${{ env.VERSION }}
          name: Device Monitor Development Build ${{ env.VERSION }}
          body: |
            # Device Monitor Development Build ${{ env.VERSION }}

            This is a development build created manually or from the latest commit.

            ## üì¶ Available Downloads
            - Linux: device_monitor_linux_${{ env.VERSION }}.tar.gz
            - Windows: device_monitor_windows_${{ env.VERSION }}.zip

            **‚ö†Ô∏è Development Build Notice**
            This build is for testing purposes and may contain experimental features.
          draft: false
          prerelease: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
