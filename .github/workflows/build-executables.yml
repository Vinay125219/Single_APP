name: Build GUARD Executables

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: false
        default: "dev"

env:
  PYTHON_VERSION: "3.9"
  APP_NAME: "GUARD"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: centos:7
      options: --privileged

    steps:
      - name: Install Git and dependencies
        run: |
          yum install -y git wget gcc gcc-c++ make openssl-devel \
            bzip2-devel libffi-devel zlib-devel readline-devel \
            sqlite-devel tk-devel ncurses-devel gdbm-devel \
            xz-devel expat-devel

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Python 3.9
        run: |
          cd /tmp
          wget https://www.python.org/ftp/python/3.9.18/Python-3.9.18.tgz
          tar -xzf Python-3.9.18.tgz
          cd Python-3.9.18
          ./configure --enable-optimizations --with-ensurepip=install
          make -j$(nproc)
          make altinstall
          ln -sf /usr/local/bin/python3.9 /usr/local/bin/python3
          ln -sf /usr/local/bin/pip3.9 /usr/local/bin/pip3
          python3 --version
          pip3 --version

      - name: Install Python dependencies
        run: |
          pip3 install --upgrade pip
          pip3 install pyinstaller
          if [ -f requirements.txt ]; then
            pip3 install -r requirements.txt
          fi

      - name: Verify GLIBC version
        run: |
          echo "System GLIBC version:"
          ldd --version | head -1

      - name: Create version info
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Build executable with PyInstaller
        run: |
          # Create PyInstaller spec file with enhanced icon support
          cat > device_monitor.spec <<'EOF'
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          a = Analysis(
              ['main.py'],
              pathex=['.'],
              binaries=[],
              datas=[('assets/guard_icon.png', 'assets')],
              hiddenimports=[
                  'tkinter',
                  'tkinter.ttk',
                  'tkinter.messagebox',
                  'tkinter.filedialog',
                  'threading',
                  'subprocess',
                  'queue',
                  'logging',
                  'pathlib',
                  'json',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='GUARD',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
          )
          EOF

          # Verify icon file exists
          if [ ! -f "assets/guard_icon.png" ]; then
            echo "âŒ ERROR: Icon file not found: assets/guard_icon.png"
            exit 1
          fi
          echo "âœ… Icon file found: assets/guard_icon.png"

          # Build the executable
          python3 -m PyInstaller device_monitor.spec --clean --noconfirm

          # Verify executable was created
          if [ -f "dist/GUARD" ]; then
            echo "âœ… Successfully built GUARD"
            chmod +x "dist/GUARD"
            ls -lh "dist/GUARD"
            
            # Verify GLIBC compatibility
            echo "Checking GLIBC dependencies:"
            objdump -T dist/GUARD | grep GLIBC | sed 's/.*GLIBC_\([.0-9]*\).*/GLIBC_\1/g' | sort -Vu || true
          else
            echo "âŒ Failed to build executable"
            exit 1
          fi

      - name: Create release package
        run: |
          mkdir -p release/linux
          cp dist/GUARD release/linux/

          # Create README
          cat > release/linux/README.txt <<EOF
          GUARD Application - Linux Build
          Version: ${{ env.VERSION }}
          Built: $(date)
          Platform: Linux x64 (CentOS 7 / RHEL 7.9+ Compatible)
          GLIBC: 2.17 compatible

          Usage:
            ./GUARD

          System Requirements:
            - RHEL 7.9+ or CentOS 7+
            - X11 display server
            - GLIBC 2.17 or higher

          For more information, see the documentation at:
          https://github.com/${{ github.repository }}
          EOF

          # Create archive
          cd release
          tar -czf GUARD_linux_${{ env.VERSION }}.tar.gz linux/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GUARD-linux-${{ env.VERSION }}
          path: release/GUARD_linux_${{ env.VERSION }}.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install pywin32
          pip install -r requirements.txt

      - name: Create version info
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Create version resource file
        run: |
          $versionInfo = @"
          # UTF-8
          #
          # For more details about fixed file info 'ffi' see:
          # http://msdn.microsoft.com/en-us/library/ms646997.aspx
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=(1,0,0,0),
              prodvers=(1,0,0,0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
              ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'040904B0',
                  [StringStruct(u'CompanyName', u'Device Monitor'),
                  StringStruct(u'FileDescription', u'Device Monitor Application'),
                  StringStruct(u'FileVersion', u'${{ env.VERSION }}'),
                  StringStruct(u'InternalName', u'device_monitor'),
                  StringStruct(u'LegalCopyright', u'Copyright (c) 2024'),
                  StringStruct(u'OriginalFilename', u'device_monitor_windows.exe'),
                  StringStruct(u'ProductName', u'Device Monitor'),
                  StringStruct(u'ProductVersion', u'${{ env.VERSION }}')])]
                ), 
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          "@

          $versionInfo | Out-File -FilePath "version_info.py" -Encoding UTF8

      - name: Build executable with PyInstaller
        run: |
          $specContent = @"
          # -*- mode: python ; coding: utf-8 -*-

          block_cipher = None

          a = Analysis(
              ['main.py'],
              pathex=['.'],
              binaries=[],
              datas=[('assets/guard_icon.ico', 'assets')],
              hiddenimports=[
                  'tkinter',
                  'tkinter.ttk',
                  'tkinter.messagebox',
                  'tkinter.filedialog',
                  'threading',
                  'subprocess',
                  'queue',
                  'logging',
                  'pathlib',
                  'json',
                  'win32serviceutil',
                  'win32service',
                  'win32event',
                  'servicemanager',
                  'win32ts',
                  'win32con',
                  'win32api',
                  'win32gui',
                  'win32process',
              ],
              hookspath=[],
              hooksconfig={},
              runtime_hooks=[],
              excludes=[],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='GUARD',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              upx_exclude=[],
              runtime_tmpdir=None,
              console=False,
              disable_windowed_traceback=False,
              argv_emulation=False,
              target_arch=None,
              codesign_identity=None,
              entitlements_file=None,
              version='version_info.py',
              icon='assets/guard_icon.ico',
          )
          "@

          $specContent | Out-File -FilePath "device_monitor.spec" -Encoding UTF8

          # Build the executable
          pyinstaller "device_monitor.spec" --clean --noconfirm

          # Verify executable was created
          if (Test-Path "dist\GUARD.exe") {
            Write-Output "âœ… Successfully built GUARD.exe"
            Get-ChildItem "dist\GUARD.exe" | Format-List
          } else {
            Write-Output "âŒ Failed to build executable"
            exit 1
          }

      - name: Create release package
        run: |
          New-Item -ItemType Directory -Path "release\windows" -Force
          Copy-Item "dist\GUARD.exe" -Destination "release\windows\"

          # Create README
          $readmeContent = @"
          GUARD Application - Windows Build
          Version: ${{ env.VERSION }}
          Built: $(Get-Date)
          Platform: Windows x64

          Usage:
            GUARD.exe

          For more information, see the documentation at:
          https://github.com/${{ github.repository }}
          "@

          $readmeContent | Out-File -FilePath "release\windows\README.txt" -Encoding UTF8

          # Create archive
          cd release
          Compress-Archive -Path "windows" -DestinationPath "GUARD_windows_${{ env.VERSION }}.zip"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GUARD-windows-${{ env.VERSION }}
          path: release/GUARD_windows_${{ env.VERSION }}.zip

  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create version info
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare unified release package
        run: |
          mkdir -p GUARD_v${{ env.VERSION }}
          
          # Extract Linux build
          if [ -f artifacts/GUARD-linux-${{ env.VERSION }}/GUARD_linux_${{ env.VERSION }}.tar.gz ]; then
            tar -xzf artifacts/GUARD-linux-${{ env.VERSION }}/GUARD_linux_${{ env.VERSION }}.tar.gz -C GUARD_v${{ env.VERSION }}/
          fi
          
          # Extract Windows build
          if [ -f artifacts/GUARD-windows-${{ env.VERSION }}/GUARD_windows_${{ env.VERSION }}.zip ]; then
            unzip -q artifacts/GUARD-windows-${{ env.VERSION }}/GUARD_windows_${{ env.VERSION }}.zip -d GUARD_v${{ env.VERSION }}/
          fi
          
          # Create unified README
          cat > GUARD_v${{ env.VERSION }}/README.txt <<'EOF'
          ================================================
          GUARD Application - Cross-Platform Release
          Version: ${{ env.VERSION }}
          Built: $(date)
          ================================================
          
          This package contains GUARD executables for both Linux and Windows platforms.
          
          LINUX (RHEL 7.9+ / CentOS 7+):
            - Located in: linux/
            - Executable: linux/GUARD
            - Requirements: X11 display server, GLIBC 2.17+
            - Usage: cd linux && ./GUARD
          
          WINDOWS (10/11):
            - Located in: windows/
            - Executable: windows/GUARD.exe
            - Requirements: Windows 10 or later
            - Usage: Run windows\GUARD.exe
          
          FEATURES:
            âœ… USB device monitoring
            âœ… System control (shutdown/restart)
            âœ… Application launcher
            âœ… Comprehensive logging
            âœ… Cross-platform support
          
          For more information and documentation:
          https://github.com/${{ github.repository }}
          ================================================
          EOF
          
          # Create unified archive
          mkdir -p release-assets
          tar -czf release-assets/GUARD_v${{ env.VERSION }}_all-platforms.tar.gz GUARD_v${{ env.VERSION }}/
          
          # Also create a zip version for Windows users
          zip -r -q release-assets/GUARD_v${{ env.VERSION }}_all-platforms.zip GUARD_v${{ env.VERSION }}/
          
          # List the contents
          echo "Release package contents:"
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: ${{ github.ref_name }}
          name: GUARD v${{ env.VERSION }}
          body: |
            # GUARD v${{ env.VERSION }}

            ## ðŸ“¦ Unified Cross-Platform Package

            This release contains **both Linux and Windows executables** in a single download:
            - **GUARD_v${{ env.VERSION }}_all-platforms.tar.gz** - For Linux/Unix systems
            - **GUARD_v${{ env.VERSION }}_all-platforms.zip** - For Windows systems

            Both archives contain the same organized folder structure with executables for both platforms.

            ## ðŸš€ Quick Start

            ### Linux (RHEL 7.9+ / CentOS 7+)
            ```bash
            # Extract the archive
            tar -xzf GUARD_v${{ env.VERSION }}_all-platforms.tar.gz
            cd GUARD_v${{ env.VERSION }}/linux/

            # Run the executable
            ./GUARD
            ```

            ### Windows (10/11)
            ```cmd
            REM Extract the ZIP file
            REM Navigate to GUARD_v${{ env.VERSION }}\windows\
            REM Run: GUARD.exe
            ```

            ## ðŸ“‹ System Requirements

            **Linux (RHEL 7.9+ / CentOS 7+)**
            - X11 display server
            - GLIBC 2.17 or higher
            - No additional dependencies required

            **Windows (10/11)**
            - No additional dependencies required

            ## ðŸ”§ Features

            - âœ… USB device monitoring
            - âœ… System control (shutdown/restart)
            - âœ… Application launcher
            - âœ… Comprehensive logging
            - âœ… Cross-platform support

            ## ðŸ”„ What's New in This Build

            - **RHEL 7.9 Compatibility**: Linux executable now built on CentOS 7 with GLIBC 2.17
            - **Icon Support**: Proper icon display on both platforms
            - **Unified Package**: Both platforms in one convenient download

            Built with â¤ï¸ using GitHub Actions
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Development Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: dev-${{ env.VERSION }}
          name: GUARD Development Build ${{ env.VERSION }}
          body: |
            # GUARD Development Build ${{ env.VERSION }}

            This is a development build created manually or from the latest commit.

            ## ðŸ“¦ Unified Package

            Both Linux and Windows executables are included in single archives:
            - **GUARD_v${{ env.VERSION }}_all-platforms.tar.gz** - For Linux/Unix
            - **GUARD_v${{ env.VERSION }}_all-platforms.zip** - For Windows

            **âš ï¸ Development Build Notice**
            This build is for testing purposes and may contain experimental features.
            
            ## Platforms Included
            - Linux: RHEL 7.9+ / CentOS 7+ compatible (GLIBC 2.17)
            - Windows: 10/11
          draft: false
          prerelease: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
