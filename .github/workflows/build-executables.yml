name: Build GUARD Application

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 1.0.0)"
        required: false
        default: "dev"

env:
  APP_NAME: "GUARD"

jobs:
  # ============================================================
  # Linux Build - Using CentOS 7 for RHEL 7.x/9.x Compatibility
  # ============================================================
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build executable inside CentOS 7 container
        uses: addnab/docker-run-action@v3
        with:
          image: centos:7
          options: -v ${{ github.workspace }}:/src
          run: |
            set -e
            
            echo "=== Fixing CentOS 7 repository URLs ==="
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/CentOS-*.repo
            sed -i 's|#baseurl=http://mirror.centos.org/centos|baseurl=http://vault.centos.org/centos|g' /etc/yum.repos.d/CentOS-*.repo
            
            echo "=== Installing system dependencies ==="
            yum -y update
            yum -y install epel-release
            yum -y install \
              python3 python3-pip python3-devel \
              gcc gcc-c++ make which \
              tk tcl python3-tkinter \
              patchelf scons \
              zlib-devel zlib-static glibc-static
            
            echo "=== Python version ==="
            python3 --version
            
            echo "=== Installing Python dependencies ==="
            pip3 install --upgrade pip setuptools wheel
            pip3 install pyinstaller Pillow staticx patchelf-wrapper
            
            cd /src
            
            echo "=== Verifying main.py syntax ==="
            python3 -c "import main; print('‚úÖ Script syntax OK')"
            
            echo "=== Building executable with PyInstaller ==="
            export TCL_LIBRARY=/usr/share/tcl8.5
            export TK_LIBRARY=/usr/share/tk8.5
            
            pyinstaller --onefile --noconsole main.py \
              --name GUARD_linux_temp \
              --add-binary "/usr/lib64/libtcl8.5.so:." \
              --add-binary "/usr/lib64/libtk8.5.so:." \
              --add-data "/usr/share/tcl8.5:lib/tcl8.5" \
              --add-data "/usr/share/tk8.5:lib/tk8.5" \
              --hidden-import tkinter \
              --hidden-import tkinter.ttk \
              --hidden-import tkinter.messagebox \
              --hidden-import tkinter.filedialog \
              --hidden-import threading \
              --hidden-import subprocess \
              --hidden-import queue \
              --hidden-import logging \
              --hidden-import pathlib \
              --hidden-import json \
              --clean
            
            echo "=== Applying staticx for GLIBC independence ==="
            staticx dist/GUARD_linux_temp dist/GUARD_linux
            
            if [ -f "dist/GUARD_linux" ]; then
              chmod +x "dist/GUARD_linux"
              echo "‚úÖ Successfully built GUARD_linux"
              ls -lh "dist/GUARD_linux"
              
              echo "=== Checking GLIBC requirements ==="
              objdump -T dist/GUARD_linux 2>/dev/null | grep GLIBC || echo "‚úÖ Static binary - no GLIBC dependency"
            else
              echo "‚ùå Failed to build executable"
              exit 1
            fi

      - name: Create release package
        run: |
          mkdir -p release/linux
          cp dist/GUARD_linux release/linux/
          
          if [ -f "assets/guard_icon.png" ]; then
            cp assets/guard_icon.png release/linux/
          fi
          
          cat > release/linux/README.txt << EOF
          GUARD Application - Linux Build
          ================================
          Version: ${{ env.VERSION }}
          Built: $(date)
          Platform: Linux x64 (RHEL 7.x, RHEL 9.x, CentOS, Ubuntu compatible)
          
          This executable is statically linked and compatible with:
          - RHEL 7.x (7.9+)
          - RHEL 8.x
          - RHEL 9.x
          - CentOS 7/8
          - Ubuntu 18.04+
          - Most Linux distributions with X11
          
          Usage:
            chmod +x GUARD_linux
            ./GUARD_linux
          
          Requirements:
            - X11 display server
            - No additional dependencies required (statically linked)
          
          For more information, see:
          https://github.com/${{ github.repository }}
          EOF
          
          cd release
          tar -czf GUARD_linux_${{ env.VERSION }}.tar.gz linux/

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GUARD-linux-${{ env.VERSION }}
          path: release/GUARD_linux_${{ env.VERSION }}.tar.gz

  # ============================================================
  # Windows Build - Windows 10/11 Compatible
  # ============================================================
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Set version
        id: version
        shell: bash
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pywin32 Pillow WMI
          pip install -r requirements.txt

      - name: Create version resource file
        run: |
          $versionInfo = @"
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers=(1,0,0,0),
              prodvers=(1,0,0,0),
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0, 0)
            ),
            kids=[
              StringFileInfo(
                [
                StringTable(
                  u'040904B0',
                  [StringStruct(u'CompanyName', u'GUARD Application'),
                  StringStruct(u'FileDescription', u'GUARD - Device Monitor Application'),
                  StringStruct(u'FileVersion', u'1.0.0'),
                  StringStruct(u'InternalName', u'GUARD'),
                  StringStruct(u'LegalCopyright', u'Copyright (c) 2024'),
                  StringStruct(u'OriginalFilename', u'GUARD_windows.exe'),
                  StringStruct(u'ProductName', u'GUARD Application'),
                  StringStruct(u'ProductVersion', u'1.0.0')])
                ]
              ), 
              VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
            ]
          )
          "@
          
          $versionInfo | Out-File -FilePath "version_info.py" -Encoding UTF8

      - name: Build executable with PyInstaller
        run: |
          $iconPath = "assets\guard_icon.ico"
          $iconArg = ""
          
          if (Test-Path $iconPath) {
            $iconArg = "--icon=$iconPath"
            Write-Output "Using icon: $iconPath"
          }
          
          pyinstaller --onefile --noconsole main.py `
            --name GUARD_windows `
            --version-file version_info.py `
            $iconArg `
            --hidden-import tkinter `
            --hidden-import tkinter.ttk `
            --hidden-import tkinter.messagebox `
            --hidden-import tkinter.filedialog `
            --hidden-import threading `
            --hidden-import subprocess `
            --hidden-import queue `
            --hidden-import logging `
            --hidden-import pathlib `
            --hidden-import json `
            --hidden-import win32api `
            --hidden-import win32con `
            --hidden-import win32gui `
            --hidden-import win32process `
            --hidden-import wmi `
            --clean --noconfirm
          
          if (Test-Path "dist\GUARD_windows.exe") {
            Write-Output "‚úÖ Successfully built GUARD_windows.exe"
            Get-ChildItem "dist\GUARD_windows.exe" | Format-List
          } else {
            Write-Output "‚ùå Failed to build executable"
            exit 1
          }

      - name: Create release package
        run: |
          New-Item -ItemType Directory -Path "release\windows" -Force
          Copy-Item "dist\GUARD_windows.exe" -Destination "release\windows\"
          
          if (Test-Path "assets\guard_icon.ico") {
            Copy-Item "assets\guard_icon.ico" -Destination "release\windows\"
          }
          
          $readmeContent = @"
          GUARD Application - Windows Build
          ==================================
          Version: ${{ env.VERSION }}
          Built: $(Get-Date)
          Platform: Windows x64 (Windows 10/11 compatible)
          
          This executable is compatible with:
          - Windows 10 (all versions)
          - Windows 11 (all versions)
          - Windows Server 2016+
          
          Usage:
            Double-click GUARD_windows.exe to run
          
          Requirements:
            - No additional dependencies required
          
          For more information, see:
          https://github.com/${{ github.repository }}
          "@
          
          $readmeContent | Out-File -FilePath "release\windows\README.txt" -Encoding UTF8
          
          cd release
          Compress-Archive -Path "windows" -DestinationPath "GUARD_windows_${{ env.VERSION }}.zip"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GUARD-windows-${{ env.VERSION }}
          path: release/GUARD_windows_${{ env.VERSION }}.zip

  # ============================================================
  # Create Combined Release
  # ============================================================
  create-release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "dev" ]; then
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
            else
              VERSION="dev-$(date +%Y%m%d-%H%M%S)"
            fi
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -exec cp {} release-assets/ \;
          find artifacts -name "*.zip" -exec cp {} release-assets/ \;
          echo "=== Release Assets ==="
          ls -la release-assets/

      - name: Create Release (Tagged)
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: ${{ github.ref_name }}
          name: GUARD Application v${{ env.VERSION }}
          body: |
            # GUARD Application v${{ env.VERSION }}

            ## üì¶ Downloads

            | Platform | File | Compatibility |
            |----------|------|---------------|
            | Linux | GUARD_linux_${{ env.VERSION }}.tar.gz | RHEL 7.9+, 9.x, CentOS, Ubuntu |
            | Windows | GUARD_windows_${{ env.VERSION }}.zip | Windows 10, 11 |

            ## üöÄ Quick Start

            **Linux:**
            ```bash
            tar -xzf GUARD_linux_${{ env.VERSION }}.tar.gz && cd linux && chmod +x GUARD_linux && ./GUARD_linux
            ```

            **Windows:** Extract ZIP and double-click `GUARD_windows.exe`

            ## üîß Features
            - USB device monitoring (4750, 4761)
            - System control (shutdown/restart)
            - Application launcher
            - Cross-platform support
          draft: false
          prerelease: false
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Development Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && !startsWith(github.ref, 'refs/tags/v')
        with:
          tag_name: dev-${{ env.VERSION }}
          name: GUARD Development Build ${{ env.VERSION }}
          body: |
            # GUARD Development Build ${{ env.VERSION }}

            ‚ö†Ô∏è **Development build for testing purposes**

            - Linux: GUARD_linux_${{ env.VERSION }}.tar.gz
            - Windows: GUARD_windows_${{ env.VERSION }}.zip
          draft: false
          prerelease: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
